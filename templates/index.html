{% extends "base.html" %}

{% block title %}Speech Coach - Speech Practice Coach{% endblock %}

{% block content %}
<section class="space-y-8">
  <header>
    <p class="text-sm uppercase tracking-[0.3em] text-cyan-200/80">Speech Coach</p>
    <h1 class="mt-2 font-display text-3xl font-semibold text-white">Record, compare, and refine your delivery</h1>
    <p class="mt-3 text-sm text-slate-200/80">Choose a sentence or paragraph, record your attempt, and receive instant similarity scores.</p>
  </header>

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% set alert_styles = {
    'danger': 'border-rose-400/60 bg-rose-500/10 text-rose-100',
    'success': 'border-emerald-400/60 bg-emerald-500/10 text-emerald-100',
    'info': 'border-sky-400/60 bg-sky-500/10 text-sky-100'
  } %}
  <div class="space-y-3">
    {% for category, message in messages %}
    {% set level = 'danger' if category == 'error' else 'success' if category == 'success' else 'info' %}
    <div class="flex items-start justify-between gap-4 rounded-2xl border px-4 py-3 text-sm {{ alert_styles[level] }}">
      <span>{{ message }}</span>
      <button type="button" class="text-lg leading-none text-white/70 transition hover:text-white" onclick="this.parentElement.remove()">&times;</button>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}

  <section class="rounded-3xl border border-white/10 bg-slate-900/60 p-6 shadow-panel backdrop-blur-xl">
    <h2 class="text-sm font-semibold text-slate-100">Choose practice mode</h2>
    <div class="mt-4 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex flex-wrap gap-4">
        <label class="inline-flex items-center gap-2 text-sm text-slate-100/90">
          <input type="radio" name="contentType" value="sentence" class="h-4 w-4 border-white/30 bg-transparent text-cyan-400 focus:ring-cyan-300" checked>
          <span>Sentences</span>
        </label>
        <label class="inline-flex items-center gap-2 text-sm text-slate-100/90">
          <input type="radio" name="contentType" value="paragraph" class="h-4 w-4 border-white/30 bg-transparent text-cyan-400 focus:ring-cyan-300">
          <span>Paragraphs</span>
        </label>
      </div>
    
    </div>
    <p class="mt-3 text-xs text-slate-200/70">Switch modes, then tap Next to cycle through available practice passages.</p>
  </section>
  <section class="rounded-3xl border border-white/10 bg-slate-900/50 p-6 shadow-panel backdrop-blur-xl">
    
    <h2 id="contentHeading" class="font-display text-lg font-semibold text-white">{{ 'Practice Sentence' if sentences else ('Practice Paragraph' if paragraphs else 'Practice Content') }}</h2>
    <p id="targetContent" class="mt-2 text-lg text-slate-100/90">{{ sentences[0].text if sentences else (paragraphs[0].text if paragraphs else '') }}</p>
    <div class="py-2">
      <button id="nextContent" class="inline-flex items-center justify-center rounded-xl border border-white/30 px-4 py-2 text-sm font-semibold text-white transition hover:border-cyan-300 hover:text-cyan-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-cyan-300">
        Next
      </button>
      </div>
    
  </section>

  <section class="rounded-3xl border border-white/10 bg-slate-900/50 p-6 shadow-panel backdrop-blur-xl">
    <div class="flex flex-col gap-4 sm:flex-row">
      <button id="startBtn" class="inline-flex w-full items-center justify-center rounded-xl bg-cyan-500 px-4 py-3 text-base font-semibold text-slate-900 transition hover:bg-cyan-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-cyan-200">Start Recording</button>
      <button id="stopBtn" class="inline-flex w-full items-center justify-center rounded-xl bg-slate-700 px-4 py-3 text-base font-semibold text-white transition hover:bg-slate-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-200 disabled:cursor-not-allowed disabled:bg-slate-800/60" disabled>Stop Recording</button>
    </div>
    <p class="mt-4 text-sm text-slate-200/80" id="statusMessage">Press start to begin recording.</p>
  </section>

  <section class="rounded-3xl border border-white/10 bg-slate-900/50 p-6 shadow-panel backdrop-blur-xl" id="attentionSection">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
      <div>
        <h2 class="font-display text-lg font-semibold text-white">Attention tracking (optional)</h2>
        <p class="mt-2 text-sm text-slate-200/80">Uses on-device MediaPipe face landmarks to estimate whether you're looking at the screen. Nothing is stored or uploaded.</p>
        <div class="mt-4 flex flex-wrap gap-3">
          <button id="startCameraBtn" class="inline-flex items-center justify-center rounded-xl bg-emerald-400 px-4 py-2 text-sm font-semibold text-slate-900 transition hover:bg-emerald-300 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-200">Start camera</button>
          <button id="stopCameraBtn" class="inline-flex items-center justify-center rounded-xl bg-slate-700 px-4 py-2 text-sm font-semibold text-white transition hover:bg-slate-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-200" disabled>Stop camera</button>
        </div>
        <div class="mt-4 grid gap-3 text-sm text-slate-200/90 sm:grid-cols-2">
          <div class="rounded-2xl border border-white/10 bg-black/20 px-4 py-3">
            <p class="text-xs uppercase tracking-wide text-slate-300/70">Attention</p>
            <p id="attentionScore" class="mt-2 text-2xl font-semibold text-emerald-300">--%</p>
          </div>
          <div class="rounded-2xl border border-white/10 bg-black/20 px-4 py-3">
            <p class="text-xs uppercase tracking-wide text-slate-300/70">Status</p>
            <p id="attentionStatus" class="mt-2 text-base font-semibold text-white">Camera idle</p>
          </div>
        </div>
        <div class="mt-4 rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-sm text-slate-200/90">
          <p class="text-xs uppercase tracking-wide text-slate-300/70">Last Recording Average</p>
          <p id="attentionAverage" class="mt-2 text-2xl font-semibold text-emerald-300">--%</p>
        </div>
      </div>
      <div class="relative w-full max-w-lg overflow-hidden rounded-2xl border border-white/10 bg-black/30">
        <video id="attentionVideo" class="h-full w-full object-cover" autoplay muted playsinline></video>
        <canvas id="attentionCanvas" class="pointer-events-none absolute inset-0 h-full w-full"></canvas>
      </div>
    </div>
  </section>

  <section class="rounded-3xl border border-white/10 bg-slate-900/50 p-6 shadow-panel backdrop-blur-xl" id="results" hidden>
    <h2 class="font-display text-lg font-semibold text-white">Results</h2>
    <dl class="mt-4 space-y-3 text-sm text-slate-200/90">
      <div class="flex flex-col gap-1">
        <dt class="font-semibold uppercase tracking-wide text-xs text-slate-300/70">Transcript</dt>
        <dd id="transcriptText" class="rounded-xl bg-black/30 px-4 py-3 text-white">-</dd>
      </div>
      <div class="flex flex-col gap-1">
        <dt class="font-semibold uppercase tracking-wide text-xs text-slate-300/70">Similarity Score</dt>
        <dd id="scoreValue" class="text-2xl font-semibold text-cyan-300">0%</dd>
      </div>
    </dl>
  </section>
</section>
{% endblock %}

{% block scripts %}
<script>
  window.APP_CONFIG = {
    sentences: {{ sentences | tojson }},
    paragraphs: {{ paragraphs | tojson }},
  };
</script>
<script src="{{ url_for('static', filename='js/app.js') }}" defer></script>
<script type="module" src="{{ url_for('static', filename='js/eye-tracking.js') }}"></script>
{% endblock %}
